@startuml AutoGen_Framework_Corrected

!define CORE_COLOR #E8F4F8
!define AGENTCHAT_COLOR #F0E68C
!define EXTENSIONS_COLOR #FFE4E1
!define PROTOCOL_COLOR #E6E6FA

' ============================================================================
' LEGEND
' ============================================================================
legend right
  |<back:#E8F4F8>      </back>| autogen_core |
  |<back:#F0E68C>      </back>| autogen_agentchat |
  |<back:#FFE4E1>      </back>| autogen_ext |
  |<back:#E6E6FA>      </back>| Protocol/Interface |
endlegend

' ============================================================================
' CORE PROTOCOLS AND BASE CLASSES
' ============================================================================

package "autogen_core" <<Rectangle>> {

    interface Agent <<Protocol>> PROTOCOL_COLOR {
        +{abstract} id: AgentId
        +{abstract} metadata: AgentMetadata
    }

    abstract class BaseAgent CORE_COLOR {
        #_id: AgentId
        #_metadata: AgentMetadata
        +__init__(description: str)
        +{abstract} on_message()
        +save_state(): Mapping
        +load_state(state: Mapping)
    }

    class AgentId CORE_COLOR {
        +type: str
        +key: str
        +__init__(type: str, key: str)
    }

    class AgentMetadata CORE_COLOR {
        +description: str
        +__init__(description: str)
    }

    class AgentProxy CORE_COLOR {
        +id: AgentId
        +runtime: AgentRuntime
    }

    abstract class AgentRuntime CORE_COLOR {
        +{abstract} register(type: str, agent_factory)
        +{abstract} send_message(message, recipient: AgentId)
        +{abstract} publish_message(message, topic_id: TopicId)
        +{abstract} start()
        +{abstract} stop()
    }

    class SingleThreadedAgentRuntime CORE_COLOR {
        +register(type: str, agent_factory)
        +send_message(message, recipient: AgentId)
        +publish_message(message, topic_id: TopicId)
        +start()
        +stop()
    }

    class RoutedAgent CORE_COLOR {
        +on_message(message, ctx: MessageContext)
    }

    class ClosureAgent CORE_COLOR {
        #_closure: Callable
        +on_message(message, ctx: MessageContext)
    }

    class MessageContext CORE_COLOR {
        +sender: AgentId
        +topic_id: TopicId
        +cancellation_token: CancellationToken
    }

    class MessageHandlerContext CORE_COLOR {
        +agent_id: AgentId
        +cancellation_token: CancellationToken
    }

    class TopicId CORE_COLOR {
        +type: str
        +source: str
        +__init__(type: str, source: str)
    }

    class DefaultTopicId CORE_COLOR {
    }

    abstract class Subscription CORE_COLOR {
        +{abstract} is_match(topic_id: TopicId): bool
    }

    class TypeSubscription CORE_COLOR {
        +topic_type: str
        +is_match(topic_id: TopicId): bool
    }

    class DefaultSubscription CORE_COLOR {
        +is_match(topic_id: TopicId): bool
    }

    class TypePrefixSubscription CORE_COLOR {
        +topic_type_prefix: str
        +is_match(topic_id: TopicId): bool
    }

    class CancellationToken CORE_COLOR {
        +is_cancelled: bool
        +cancel()
    }

    class FunctionCall CORE_COLOR {
        +id: str
        +name: str
        +arguments: str
    }

    class Image CORE_COLOR {
        +data: bytes
        +mime_type: str
    }

    class UnknownPayload CORE_COLOR {
        +data: bytes
        +content_type: str
    }
}

Agent <|.. BaseAgent
BaseAgent <|-- RoutedAgent
BaseAgent <|-- ClosureAgent
AgentRuntime <|-- SingleThreadedAgentRuntime
Subscription <|-- TypeSubscription
Subscription <|-- DefaultSubscription
Subscription <|-- TypePrefixSubscription
TopicId <|-- DefaultTopicId

' ============================================================================
' COMPONENT SYSTEM
' ============================================================================

package "autogen_core (Component System)" <<Rectangle>> {

    interface ComponentBase CORE_COLOR {
        +component_type: ComponentType
    }

    interface Component<T> CORE_COLOR {
        +component_version: int
        +component_config_schema: type
        +component_provider_override: str
        +_to_config(): T
        +_from_config(config: T): Self
    }

    class ComponentModel CORE_COLOR {
        +provider: str
        +component_type: str
        +version: int
        +config: Dict
    }

    class ComponentLoader CORE_COLOR {
        +{static} load_component(config: ComponentModel)
        +{static} save_component(component)
    }

    enum ComponentSchemaType CORE_COLOR {
        PYDANTIC
        JSON_SCHEMA
    }
}

' ============================================================================
' MODEL CLIENT HIERARCHY
' ============================================================================

package "autogen_core.models" <<Rectangle>> {

    interface ChatCompletionClient <<Protocol>> PROTOCOL_COLOR {
        +{abstract} create(messages, tools, json_output, extra_create_args, cancellation_token): CreateResult
        +{abstract} create_stream(messages, tools, json_output, extra_create_args, cancellation_token): AsyncGenerator
        +{abstract} actual_usage(): RequestUsage
        +{abstract} total_usage(): RequestUsage
        +{abstract} count_tokens(messages, tools, json_output): int
        +{abstract} remaining_tokens(messages, tools, json_output): int
    }

    class ModelCapabilities CORE_COLOR {
        +vision: bool
        +function_calling: bool
        +json_output: bool
    }

    class ModelInfo CORE_COLOR {
        +family: ModelFamily
        +context_window: int
        +capabilities: ModelCapabilities
    }

    enum ModelFamily CORE_COLOR {
        GPT_4
        GPT_3_5
        CLAUDE
        GEMINI
        UNKNOWN
    }

    class SystemMessage CORE_COLOR {
        +content: str
    }

    class UserMessage CORE_COLOR {
        +content: str | List
    }

    class AssistantMessage CORE_COLOR {
        +content: str | List
        +function_calls: List[FunctionCall]
    }

    class FunctionExecutionResult CORE_COLOR {
        +content: str
        +call_id: str
    }

    class FunctionExecutionResultMessage CORE_COLOR {
        +content: List[FunctionExecutionResult]
    }

    class CreateResult CORE_COLOR {
        +content: str
        +finish_reason: str
        +usage: RequestUsage
        +cached: bool
        +logprobs: List | None
    }

    class RequestUsage CORE_COLOR {
        +prompt_tokens: int
        +completion_tokens: int
        +total_tokens: int
    }

    class TopLogprob CORE_COLOR {
        +token: str
        +logprob: float
    }

    class ChatCompletionTokenLogprob CORE_COLOR {
        +token: str
        +logprob: float
        +top_logprobs: List[TopLogprob]
    }
}

ChatCompletionClient ..> CreateResult : produces
ChatCompletionClient ..> RequestUsage : uses
CreateResult *-- RequestUsage

' ============================================================================
' MODEL CLIENT EXTENSIONS
' ============================================================================

package "autogen_ext.models" <<Rectangle>> {

    abstract class BaseOpenAIChatCompletionClient EXTENSIONS_COLOR {
        #_model: str
        #_client: AsyncOpenAI
        #_model_info: ModelInfo
        +create(messages, tools, json_output, extra_create_args, cancellation_token): CreateResult
        +create_stream(messages, tools, json_output, extra_create_args, cancellation_token): AsyncGenerator
        +actual_usage(): RequestUsage
        +total_usage(): RequestUsage
        +count_tokens(messages, tools, json_output): int
        +remaining_tokens(messages, tools, json_output): int
    }

    class OpenAIChatCompletionClient EXTENSIONS_COLOR {
        +__init__(model, api_key, base_url, timeout, max_retries, model_info)
    }

    class AzureOpenAIChatCompletionClient EXTENSIONS_COLOR {
        +__init__(model, api_key, azure_endpoint, api_version, azure_deployment, timeout, max_retries, model_info)
    }

    abstract class BaseAnthropicChatCompletionClient EXTENSIONS_COLOR {
        #_model: str
        #_client: AsyncAnthropic
        #_model_info: ModelInfo
        +create(messages, tools, json_output, extra_create_args, cancellation_token): CreateResult
        +create_stream(messages, tools, json_output, extra_create_args, cancellation_token): AsyncGenerator
    }

    class AnthropicChatCompletionClient EXTENSIONS_COLOR {
        +__init__(model, api_key, timeout, max_retries, model_info)
    }

    class AnthropicBedrockChatCompletionClient EXTENSIONS_COLOR {
        +__init__(model, region, access_key_id, secret_access_key, timeout, max_retries, model_info)
    }

    class OllamaChatCompletionClient EXTENSIONS_COLOR {
        +__init__(model, base_url, timeout, max_retries, model_info)
    }

    class AzureAIChatCompletionClient EXTENSIONS_COLOR {
        +__init__(model, endpoint, credential, timeout, max_retries, model_info)
    }

    class LlamaCppChatCompletionClient EXTENSIONS_COLOR {
        +__init__(model_path, n_ctx, n_gpu_layers, model_info)
    }

    class ReplayChatCompletionClient EXTENSIONS_COLOR {
        #_recorded_responses: List
        +__init__(recorded_responses)
    }

    class ChatCompletionCache EXTENSIONS_COLOR {
        #_client: ChatCompletionClient
        #_cache_store: CacheStore
        +__init__(client, cache_store)
        +create(messages, tools, json_output, extra_create_args, cancellation_token): CreateResult
    }

    class SKChatCompletionAdapter EXTENSIONS_COLOR {
        #_sk_client: ChatCompletionClientBase
        #_kernel: Kernel | None
        +__init__(sk_client, kernel, prompt_settings, model_info, service_id)
        +create(messages, tools, json_output, extra_create_args, cancellation_token): CreateResult
    }
}

ChatCompletionClient <|.. BaseOpenAIChatCompletionClient
BaseOpenAIChatCompletionClient <|-- OpenAIChatCompletionClient
BaseOpenAIChatCompletionClient <|-- AzureOpenAIChatCompletionClient
Component <|.. OpenAIChatCompletionClient
Component <|.. AzureOpenAIChatCompletionClient

ChatCompletionClient <|.. BaseAnthropicChatCompletionClient
BaseAnthropicChatCompletionClient <|-- AnthropicChatCompletionClient
BaseAnthropicChatCompletionClient <|-- AnthropicBedrockChatCompletionClient
Component <|.. AnthropicChatCompletionClient

ChatCompletionClient <|.. OllamaChatCompletionClient
ChatCompletionClient <|.. AzureAIChatCompletionClient
ChatCompletionClient <|.. LlamaCppChatCompletionClient
ChatCompletionClient <|.. ReplayChatCompletionClient
ChatCompletionClient <|.. ChatCompletionCache
ChatCompletionClient <|.. SKChatCompletionAdapter

ChatCompletionCache o-- ChatCompletionClient : wraps

' ============================================================================
' CACHE STORE
' ============================================================================

package "autogen_core (Cache)" <<Rectangle>> {

    interface CacheStore <<Protocol>> PROTOCOL_COLOR {
        +{abstract} get(key: str): bytes | None
        +{abstract} set(key: str, value: bytes)
        +{abstract} close()
    }

    class InMemoryStore CORE_COLOR {
        #_cache: Dict[str, bytes]
        +get(key: str): bytes | None
        +set(key: str, value: bytes)
        +close()
    }
}

package "autogen_ext.cache_store" <<Rectangle>> {

    class DiskCacheStore EXTENSIONS_COLOR {
        #_cache_dir: str
        +get(key: str): bytes | None
        +set(key: str, value: bytes)
        +close()
    }

    class RedisStore EXTENSIONS_COLOR {
        #_redis_client: Redis
        +get(key: str): bytes | None
        +set(key: str, value: bytes)
        +close()
    }
}

CacheStore <|.. InMemoryStore
CacheStore <|.. DiskCacheStore
CacheStore <|.. RedisStore

' ============================================================================
' TOOLS HIERARCHY
' ============================================================================

package "autogen_core.tools" <<Rectangle>> {

    interface Tool <<Protocol>> PROTOCOL_COLOR {
        +{abstract} name: str
        +{abstract} description: str
        +{abstract} args_type: type
        +{abstract} return_type: type
        +{abstract} run_json(args: str, cancellation_token): str
    }

    interface StreamTool <<Protocol>> PROTOCOL_COLOR {
        +{abstract} run_stream(args, cancellation_token): AsyncGenerator
    }

    class ToolSchema CORE_COLOR {
        +name: str
        +description: str
        +parameters: ParametersSchema
    }

    class ParametersSchema CORE_COLOR {
        +type: str
        +properties: Dict
        +required: List[str]
    }

    abstract class BaseTool CORE_COLOR {
        +{abstract} name: str
        +{abstract} description: str
        +{abstract} args_type: type
        +{abstract} return_type: type
        +run_json(args: str, cancellation_token): str
        +{abstract} run(args, cancellation_token): Any
        +to_tool_schema(): ToolSchema
    }

    class BaseToolWithState CORE_COLOR {
        +save_state(): Mapping
        +load_state(state: Mapping)
    }

    class BaseStreamTool CORE_COLOR {
        +run_stream(args, cancellation_token): AsyncGenerator
    }

    class FunctionTool CORE_COLOR {
        #_func: Callable
        #_name: str
        #_description: str
        +__init__(func, name, description)
        +run(args, cancellation_token): Any
    }

    class ToolResult CORE_COLOR {
        +content: List[TextResultContent | ImageResultContent]
    }

    class TextResultContent CORE_COLOR {
        +text: str
    }

    class ImageResultContent CORE_COLOR {
        +image: Image
    }

    abstract class Workbench CORE_COLOR {
        +{abstract} list_tools(): List[ToolSchema]
        +{abstract} call_tool(name: str, arguments: Mapping, cancellation_token, call_id): ToolResult
        +{abstract} start()
        +{abstract} stop()
        +{abstract} reset()
        +{abstract} save_state(): Mapping
        +{abstract} load_state(state: Mapping)
    }

    class StaticWorkbench CORE_COLOR {
        #_tools: List[Tool]
        +__init__(tools: List[Tool])
        +list_tools(): List[ToolSchema]
        +call_tool(name: str, arguments: Mapping, cancellation_token, call_id): ToolResult
    }

    class StaticStreamWorkbench CORE_COLOR {
        #_tools: List[Tool | StreamTool]
        +__init__(tools: List[Tool | StreamTool])
        +list_tools(): List[ToolSchema]
        +call_tool(name: str, arguments: Mapping, cancellation_token, call_id): ToolResult
    }

    class ToolOverride CORE_COLOR {
        +name: str
        +description: str | None
        +parameters: ParametersSchema | None
    }
}

Tool <|.. BaseTool
BaseTool <|-- BaseToolWithState
BaseTool <|-- BaseStreamTool
BaseTool <|-- FunctionTool
StreamTool <|.. BaseStreamTool

Tool ..> ToolSchema : creates
BaseTool ..> ToolResult : produces
ToolResult *-- TextResultContent
ToolResult *-- ImageResultContent

Workbench <|-- StaticWorkbench
Workbench <|-- StaticStreamWorkbench
ComponentBase <|.. Workbench
Component <|.. StaticWorkbench

StaticWorkbench o-- Tool : manages
StaticStreamWorkbench o-- Tool : manages
StaticStreamWorkbench o-- StreamTool : manages

' ============================================================================
' TOOL AGENT
' ============================================================================

package "autogen_core.tool_agent" <<Rectangle>> {

    class ToolAgent CORE_COLOR {
        #_tools: List[Tool]
        +__init__(name: str, tools: List[Tool])
        +on_message(message, ctx: MessageContext)
    }

    class ToolException CORE_COLOR {
        +message: str
    }

    class ToolNotFoundException CORE_COLOR {
        +tool_name: str
    }

    class InvalidToolArgumentsException CORE_COLOR {
        +tool_name: str
        +arguments: str
    }

    class ToolExecutionException CORE_COLOR {
        +tool_name: str
        +error: Exception
    }
}

BaseAgent <|-- ToolAgent
ToolException <|-- ToolNotFoundException
ToolException <|-- InvalidToolArgumentsException
ToolException <|-- ToolExecutionException

' ============================================================================
' CODE EXECUTOR
' ============================================================================

package "autogen_core.code_executor" <<Rectangle>> {

    interface CodeExecutor <<Protocol>> PROTOCOL_COLOR {
        +{abstract} execute_code_blocks(code_blocks, cancellation_token): CodeResult
        +{abstract} restart()
        +{abstract} stop()
    }

    class CodeBlock CORE_COLOR {
        +language: str
        +code: str
    }

    class CodeResult CORE_COLOR {
        +exit_code: int
        +output: str
    }

    class FunctionWithRequirements CORE_COLOR {
        +func: Callable
        +python_packages: List[str]
        +global_imports: List[str]
    }

    class Alias CORE_COLOR {
        +name: str
        +alias: str
    }

    class ImportFromModule CORE_COLOR {
        +module: str
        +imports: List[str]
    }
}

package "autogen_ext.code_executors" <<Rectangle>> {

    class LocalCommandLineCodeExecutor EXTENSIONS_COLOR {
        #_work_dir: str
        #_timeout: int
        +__init__(work_dir, timeout, virtual_env)
        +execute_code_blocks(code_blocks, cancellation_token): CodeResult
    }

    class DockerCommandLineCodeExecutor EXTENSIONS_COLOR {
        #_image: str
        #_container_name: str
        +__init__(image, container_name, timeout, work_dir, auto_remove)
        +execute_code_blocks(code_blocks, cancellation_token): CodeResult
    }

    class JupyterCodeExecutor EXTENSIONS_COLOR {
        #_jupyter_client: JupyterClient
        +__init__(jupyter_client)
        +execute_code_blocks(code_blocks, cancellation_token): JupyterCodeResult
    }

    class DockerJupyterCodeExecutor EXTENSIONS_COLOR {
        #_docker_jupyter_server: DockerJupyterServer
        +__init__(image, container_name, timeout, work_dir)
        +execute_code_blocks(code_blocks, cancellation_token): DockerJupyterCodeResult
    }

    class ACADynamicSessionsCodeExecutor EXTENSIONS_COLOR {
        #_pool_endpoint: str
        #_token_provider: TokenProvider
        +__init__(pool_endpoint, token_provider)
        +execute_code_blocks(code_blocks, cancellation_token): CodeResult
    }

    class PythonCodeExecutionTool EXTENSIONS_COLOR {
        #_executor: CodeExecutor
        +__init__(executor: CodeExecutor)
        +run(code: str, cancellation_token): str
    }
}

CodeExecutor <|.. LocalCommandLineCodeExecutor
CodeExecutor <|.. DockerCommandLineCodeExecutor
CodeExecutor <|.. JupyterCodeExecutor
CodeExecutor <|.. DockerJupyterCodeExecutor
CodeExecutor <|.. ACADynamicSessionsCodeExecutor

BaseTool <|-- PythonCodeExecutionTool
PythonCodeExecutionTool o-- CodeExecutor : uses

' ============================================================================
' MEMORY SYSTEM
' ============================================================================

package "autogen_core.memory" <<Rectangle>> {

    interface Memory <<Protocol>> PROTOCOL_COLOR {
        +{abstract} add(message, cancellation_token)
        +{abstract} query(query: str, cancellation_token): MemoryQueryResult
        +{abstract} clear()
        +{abstract} close()
    }

    class MemoryContent CORE_COLOR {
        +content: str
        +mime_type: MemoryMimeType
    }

    class MemoryQueryResult CORE_COLOR {
        +results: List[MemoryContent]
    }

    class UpdateContextResult CORE_COLOR {
        +updated_context: List
    }

    enum MemoryMimeType CORE_COLOR {
        TEXT
        IMAGE
        AUDIO
        VIDEO
    }

    class ListMemory CORE_COLOR {
        #_memories: List
        +add(message, cancellation_token)
        +query(query: str, cancellation_token): MemoryQueryResult
        +clear()
    }
}

Memory <|.. ListMemory

package "autogen_ext.memory" <<Rectangle>> {

    class ChromaDBVectorMemory EXTENSIONS_COLOR {
        #_client: chromadb.Client
        #_collection_name: str
        +add(message, cancellation_token)
        +query(query: str, cancellation_token): MemoryQueryResult
    }

    class Mem0Memory EXTENSIONS_COLOR {
        #_mem0_client: Mem0Client
        +add(message, cancellation_token)
        +query(query: str, cancellation_token): MemoryQueryResult
    }

    class RedisMemory EXTENSIONS_COLOR {
        #_redis_client: Redis
        +add(message, cancellation_token)
        +query(query: str, cancellation_token): MemoryQueryResult
    }

    class TextCanvasMemory EXTENSIONS_COLOR {
        #_canvas: TextCanvas
        +add(message, cancellation_token)
        +query(query: str, cancellation_token): MemoryQueryResult
    }
}

Memory <|.. ChromaDBVectorMemory
Memory <|.. Mem0Memory
Memory <|.. RedisMemory
Memory <|.. TextCanvasMemory

' ============================================================================
' MODEL CONTEXT
' ============================================================================

package "autogen_core.model_context" <<Rectangle>> {

    interface ChatCompletionContext <<Protocol>> PROTOCOL_COLOR {
        +{abstract} get_messages(): List
        +{abstract} add_message(message)
        +{abstract} clear()
    }

    class ChatCompletionContextState CORE_COLOR {
        +messages: List
    }

    class UnboundedChatCompletionContext CORE_COLOR {
        #_messages: List
        +get_messages(): List
        +add_message(message)
        +clear()
    }

    class BufferedChatCompletionContext CORE_COLOR {
        #_messages: List
        #_buffer_size: int
        +get_messages(): List
        +add_message(message)
    }

    class TokenLimitedChatCompletionContext CORE_COLOR {
        #_messages: List
        #_max_tokens: int
        +get_messages(): List
        +add_message(message)
    }

    class HeadAndTailChatCompletionContext CORE_COLOR {
        #_head_messages: List
        #_tail_messages: List
        #_head_size: int
        #_tail_size: int
        +get_messages(): List
        +add_message(message)
    }
}

ChatCompletionContext <|.. UnboundedChatCompletionContext
ChatCompletionContext <|.. BufferedChatCompletionContext
ChatCompletionContext <|.. TokenLimitedChatCompletionContext
ChatCompletionContext <|.. HeadAndTailChatCompletionContext

' ============================================================================
' MCP INTEGRATION
' ============================================================================

package "autogen_ext.tools.mcp" <<Rectangle>> {

    class StdioMcpToolAdapter EXTENSIONS_COLOR {
        #_server_params: StdioServerParams
        #_session: McpSession
        +list_tools(): List[ToolSchema]
        +call_tool(name: str, arguments: Mapping, cancellation_token, call_id): ToolResult
    }

    class SseMcpToolAdapter EXTENSIONS_COLOR {
        #_server_params: SseServerParams
        #_session: McpSession
        +list_tools(): List[ToolSchema]
        +call_tool(name: str, arguments: Mapping, cancellation_token, call_id): ToolResult
    }

    class StreamableHttpMcpToolAdapter EXTENSIONS_COLOR {
        #_server_params: StreamableHttpServerParams
        #_session: McpSession
        +list_tools(): List[ToolSchema]
        +call_tool(name: str, arguments: Mapping, cancellation_token, call_id): ToolResult
    }

    class McpSessionActor EXTENSIONS_COLOR {
        #_session: McpSession
        +on_message(message, ctx: MessageContext)
    }

    class McpWorkbench EXTENSIONS_COLOR {
        #_adapters: List[StdioMcpToolAdapter | SseMcpToolAdapter]
        +list_tools(): List[ToolSchema]
        +call_tool(name: str, arguments: Mapping, cancellation_token, call_id): ToolResult
        +start()
        +stop()
    }

    class StdioServerParams EXTENSIONS_COLOR {
        +command: str
        +args: List[str]
        +env: Dict | None
    }

    class SseServerParams EXTENSIONS_COLOR {
        +url: str
        +headers: Dict | None
    }

    class StreamableHttpServerParams EXTENSIONS_COLOR {
        +url: str
        +headers: Dict | None
    }
}

Workbench <|-- McpWorkbench
BaseAgent <|-- McpSessionActor
Component <|.. McpWorkbench

McpWorkbench o-- StdioMcpToolAdapter : uses
McpWorkbench o-- SseMcpToolAdapter : uses

' ============================================================================
' OTHER EXTENSION TOOLS
' ============================================================================

package "autogen_ext.tools" <<Rectangle>> {

    class LangChainToolAdapter EXTENSIONS_COLOR {
        #_langchain_tool: BaseTool
        +run(args, cancellation_token): Any
    }

    class HttpTool EXTENSIONS_COLOR {
        #_method: str
        #_url: str
        +run(args, cancellation_token): str
    }

    class AzureAISearchTool EXTENSIONS_COLOR {
        #_search_client: SearchClient
        +run(query: str, cancellation_token): SearchResults
    }
}

BaseTool <|-- LangChainToolAdapter
BaseTool <|-- HttpTool
BaseTool <|-- AzureAISearchTool

' ============================================================================
' AGENTCHAT BASE
' ============================================================================

package "autogen_agentchat.base" <<Rectangle>> {

    interface ChatAgent <<Protocol>> PROTOCOL_COLOR {
        +{abstract} name: str
        +{abstract} description: str
        +{abstract} produced_message_types: Sequence[type]
        +{abstract} on_messages(messages, cancellation_token): Response
        +{abstract} on_messages_stream(messages, cancellation_token): AsyncGenerator
    }

    abstract class BaseChatAgent AGENTCHAT_COLOR {
        #_name: str
        #_description: str
        +__init__(name: str, description: str)
        +name: str
        +description: str
        +{abstract} produced_message_types: Sequence[type]
        +{abstract} on_messages(messages, cancellation_token): Response
        +on_messages_stream(messages, cancellation_token): AsyncGenerator
        +{abstract} on_reset(cancellation_token)
        +on_pause(cancellation_token)
        +on_resume(cancellation_token)
        +save_state(): Mapping
        +load_state(state: Mapping)
        +run(task, cancellation_token, output_task_messages): TaskResult
        +run_stream(task, cancellation_token, output_task_messages): AsyncGenerator
    }

    class Response AGENTCHAT_COLOR {
        +chat_message: BaseChatMessage
        +inner_messages: List | None
    }

    class TaskResult AGENTCHAT_COLOR {
        +messages: Sequence[BaseChatMessage]
        +stop_reason: str | None
    }

    interface TaskRunner <<Protocol>> PROTOCOL_COLOR {
        +{abstract} run(task, cancellation_token, output_task_messages): TaskResult
        +{abstract} run_stream(task, cancellation_token, output_task_messages): AsyncGenerator
    }

    interface Team <<Protocol>> PROTOCOL_COLOR {
        +{abstract} name: str
        +{abstract} description: str
        +{abstract} run(task, cancellation_token, output_task_messages): TaskResult
        +{abstract} run_stream(task, cancellation_token, output_task_messages): AsyncGenerator
    }

    class Handoff AGENTCHAT_COLOR {
        +target: str
        +message: str
        +condition: Callable | None
    }

    abstract class TerminationCondition AGENTCHAT_COLOR {
        +{abstract} terminated: bool
        +{abstract} __call__(messages): StopMessage | None
        +{abstract} reset()
        +__or__(other): OrTerminationCondition
        +__and__(other): AndTerminationCondition
    }

    class AndTerminationCondition AGENTCHAT_COLOR {
        #_conditions: List[TerminationCondition]
    }

    class OrTerminationCondition AGENTCHAT_COLOR {
        #_conditions: List[TerminationCondition]
    }
}

ChatAgent <|.. BaseChatAgent
TaskRunner <|.. BaseChatAgent
ComponentBase <|.. BaseChatAgent

BaseChatAgent ..> Response : produces
BaseChatAgent ..> TaskResult : produces

' ============================================================================
' AGENTCHAT MESSAGES
' ============================================================================

package "autogen_agentchat.messages" <<Rectangle>> {

    abstract class BaseMessage AGENTCHAT_COLOR {
        +source: str
        +models_usage: RequestUsage | None
        +metadata: Dict
        +type: str
    }

    abstract class BaseChatMessage AGENTCHAT_COLOR {
        +source: str
        +models_usage: RequestUsage | None
        +metadata: Dict
        +{abstract} to_text(): str
        +{abstract} to_model_text(): str
        +{abstract} to_model_message(): LLMMessage
    }

    abstract class BaseAgentEvent AGENTCHAT_COLOR {
        +source: str
        +metadata: Dict
    }

    abstract class BaseTextChatMessage AGENTCHAT_COLOR {
        +content: str
        +to_text(): str
        +to_model_text(): str
    }

    class TextMessage AGENTCHAT_COLOR {
        +content: str
        +source: str
    }

    class MultiModalMessage AGENTCHAT_COLOR {
        +content: List[str | Image]
        +to_text(): str
    }

    class StopMessage AGENTCHAT_COLOR {
        +content: str
    }

    class HandoffMessage AGENTCHAT_COLOR {
        +content: str
        +target: str
        +context: List
    }

    class ToolCallSummaryMessage AGENTCHAT_COLOR {
        +content: str
        +call_id: str
    }

    class StructuredMessage<T> AGENTCHAT_COLOR {
        +content: T
        +format_string: str | None
    }

    class ToolCallRequestEvent AGENTCHAT_COLOR {
        +content: List[FunctionCall]
    }

    class ToolCallExecutionEvent AGENTCHAT_COLOR {
        +content: List[FunctionExecutionResult]
    }

    class MemoryQueryEvent AGENTCHAT_COLOR {
        +query: str
        +results: List
    }

    class UserInputRequestedEvent AGENTCHAT_COLOR {
        +prompt: str
    }

    class ModelClientStreamingChunkEvent AGENTCHAT_COLOR {
        +content: str
    }

    class ThoughtEvent AGENTCHAT_COLOR {
        +thought: str
    }

    class SelectSpeakerEvent AGENTCHAT_COLOR {
        +selected_speaker: str
    }

    class CodeGenerationEvent AGENTCHAT_COLOR {
        +code: str
    }

    class CodeExecutionEvent AGENTCHAT_COLOR {
        +code_result: CodeResult
    }
}

BaseMessage <|-- BaseChatMessage
BaseMessage <|-- BaseAgentEvent
BaseChatMessage <|-- BaseTextChatMessage
BaseTextChatMessage <|-- TextMessage
BaseTextChatMessage <|-- StopMessage
BaseTextChatMessage <|-- HandoffMessage
BaseTextChatMessage <|-- ToolCallSummaryMessage
BaseChatMessage <|-- MultiModalMessage
BaseChatMessage <|-- StructuredMessage
BaseAgentEvent <|-- ToolCallRequestEvent
BaseAgentEvent <|-- ToolCallExecutionEvent
BaseAgentEvent <|-- MemoryQueryEvent
BaseAgentEvent <|-- UserInputRequestedEvent
BaseAgentEvent <|-- ModelClientStreamingChunkEvent
BaseAgentEvent <|-- ThoughtEvent
BaseAgentEvent <|-- SelectSpeakerEvent
BaseAgentEvent <|-- CodeGenerationEvent
BaseAgentEvent <|-- CodeExecutionEvent

' ============================================================================
' AGENTCHAT AGENTS
' ============================================================================

package "autogen_agentchat.agents" <<Rectangle>> {

    class AssistantAgent AGENTCHAT_COLOR {
        #_model_client: ChatCompletionClient
        #_tools: List[Tool]
        #_workbench: Workbench | None
        #_model_context: ChatCompletionContext
        #_memory: Memory | None
        #_system_message: str
        +__init__(name, model_client, tools, workbench, system_message, model_context, memory)
        +on_messages(messages, cancellation_token): Response
        +produced_message_types: Sequence[type]
    }

    class CodeExecutorAgent AGENTCHAT_COLOR {
        #_code_executor: CodeExecutor
        #_model_client: ChatCompletionClient | None
        +__init__(name, code_executor, model_client)
        +on_messages(messages, cancellation_token): Response
        +produced_message_types: Sequence[type]
    }

    class UserProxyAgent AGENTCHAT_COLOR {
        #_input_func: Callable | None
        +__init__(name, description, input_func)
        +on_messages(messages, cancellation_token): Response
        +produced_message_types: Sequence[type]
    }

    class SocietyOfMindAgent AGENTCHAT_COLOR {
        #_team: Team
        #_model_client: ChatCompletionClient
        +__init__(name, team, model_client)
        +on_messages(messages, cancellation_token): Response
        +produced_message_types: Sequence[type]
    }

    class MessageFilterAgent AGENTCHAT_COLOR {
        #_config: MessageFilterConfig
        +__init__(name, config)
        +on_messages(messages, cancellation_token): Response
    }

    class MessageFilterConfig AGENTCHAT_COLOR {
        +allowed_types: List[type]
        +per_source_filters: List[PerSourceFilter]
    }

    class PerSourceFilter AGENTCHAT_COLOR {
        +source: str
        +allowed_types: List[type]
    }

    class ApprovalRequest AGENTCHAT_COLOR {
        +code: str
        +context: List
    }

    class ApprovalResponse AGENTCHAT_COLOR {
        +approved: bool
        +reason: str | None
    }
}

BaseChatAgent <|-- AssistantAgent
BaseChatAgent <|-- CodeExecutorAgent
BaseChatAgent <|-- UserProxyAgent
BaseChatAgent <|-- SocietyOfMindAgent
BaseChatAgent <|-- MessageFilterAgent

Component <|.. AssistantAgent
Component <|.. CodeExecutorAgent
Component <|.. UserProxyAgent
Component <|.. SocietyOfMindAgent

AssistantAgent o-- ChatCompletionClient : uses
AssistantAgent o-- Tool : uses
AssistantAgent o-- Workbench : uses
AssistantAgent o-- ChatCompletionContext : uses
AssistantAgent o-- Memory : uses

CodeExecutorAgent o-- CodeExecutor : uses
CodeExecutorAgent o-- ChatCompletionClient : uses

SocietyOfMindAgent o-- Team : uses
SocietyOfMindAgent o-- ChatCompletionClient : uses

MessageFilterAgent *-- MessageFilterConfig

' ============================================================================
' AGENTCHAT TOOLS
' ============================================================================

package "autogen_agentchat.tools" <<Rectangle>> {

    class AgentTool AGENTCHAT_COLOR {
        #_agent: ChatAgent
        #_max_turns: int
        +__init__(agent, max_turns)
        +run(task: str, cancellation_token): str
    }

    class TeamTool AGENTCHAT_COLOR {
        #_team: Team
        #_max_turns: int
        +__init__(team, max_turns)
        +run(task: str, cancellation_token): str
    }
}

BaseTool <|-- AgentTool
BaseTool <|-- TeamTool

AgentTool o-- ChatAgent : wraps
TeamTool o-- Team : wraps

' ============================================================================
' TERMINATION CONDITIONS
' ============================================================================

package "autogen_agentchat.conditions" <<Rectangle>> {

    class MaxMessageTermination AGENTCHAT_COLOR {
        #_max_messages: int
        #_current_count: int
        +__call__(messages): StopMessage | None
    }

    class TextMentionTermination AGENTCHAT_COLOR {
        #_text: str
        +__call__(messages): StopMessage | None
    }

    class StopMessageTermination AGENTCHAT_COLOR {
        +__call__(messages): StopMessage | None
    }

    class TokenUsageTermination AGENTCHAT_COLOR {
        #_max_tokens: int
        #_current_usage: int
        +__call__(messages): StopMessage | None
    }

    class HandoffTermination AGENTCHAT_COLOR {
        #_target: str
        +__call__(messages): StopMessage | None
    }

    class TimeoutTermination AGENTCHAT_COLOR {
        #_timeout_seconds: float
        #_start_time: float
        +__call__(messages): StopMessage | None
    }

    class ExternalTermination AGENTCHAT_COLOR {
        #_terminate_flag: bool
        +__call__(messages): StopMessage | None
        +set()
    }

    class SourceMatchTermination AGENTCHAT_COLOR {
        #_sources: List[str]
        +__call__(messages): StopMessage | None
    }

    class TextMessageTermination AGENTCHAT_COLOR {
        #_text: str
        +__call__(messages): StopMessage | None
    }

    class FunctionCallTermination AGENTCHAT_COLOR {
        #_function_name: str
        +__call__(messages): StopMessage | None
    }

    class FunctionalTermination AGENTCHAT_COLOR {
        #_condition_func: Callable
        +__call__(messages): StopMessage | None
    }
}

TerminationCondition <|-- MaxMessageTermination
TerminationCondition <|-- TextMentionTermination
TerminationCondition <|-- StopMessageTermination
TerminationCondition <|-- TokenUsageTermination
TerminationCondition <|-- HandoffTermination
TerminationCondition <|-- TimeoutTermination
TerminationCondition <|-- ExternalTermination
TerminationCondition <|-- SourceMatchTermination
TerminationCondition <|-- TextMessageTermination
TerminationCondition <|-- FunctionCallTermination
TerminationCondition <|-- FunctionalTermination
TerminationCondition <|-- AndTerminationCondition
TerminationCondition <|-- OrTerminationCondition

Component <|.. TerminationCondition

' ============================================================================
' AGENTCHAT TEAMS
' ============================================================================

package "autogen_agentchat.teams" <<Rectangle>> {

    abstract class BaseGroupChat AGENTCHAT_COLOR {
        #_participants: List[ChatAgent]
        #_termination_condition: TerminationCondition | None
        #_max_turns: int | None
        +__init__(participants, termination_condition, max_turns)
        +run(task, cancellation_token, output_task_messages): TaskResult
        +run_stream(task, cancellation_token, output_task_messages): AsyncGenerator
        +reset()
        +save_state(): Mapping
        +load_state(state: Mapping)
    }

    class RoundRobinGroupChat AGENTCHAT_COLOR {
        +__init__(participants, termination_condition, max_turns)
    }

    class SelectorGroupChat AGENTCHAT_COLOR {
        #_model_client: ChatCompletionClient
        #_selector_prompt: str
        +__init__(participants, model_client, termination_condition, selector_prompt, max_turns)
    }

    class Swarm AGENTCHAT_COLOR {
        #_handoff_config: Dict[str, List[Handoff]]
        +__init__(participants, handoff_config, termination_condition, max_turns)
    }

    class MagenticOneGroupChat AGENTCHAT_COLOR {
        #_orchestrator_client: ChatCompletionClient
        +__init__(participants, orchestrator_client, termination_condition, max_turns)
    }

    class DiGraph AGENTCHAT_COLOR {
        #_nodes: Dict[str, DiGraphNode]
        #_edges: List[DiGraphEdge]
        +add_node(node: DiGraphNode)
        +add_edge(edge: DiGraphEdge)
    }

    class DiGraphNode AGENTCHAT_COLOR {
        +id: str
        +agent: ChatAgent
    }

    class DiGraphEdge AGENTCHAT_COLOR {
        +source: str
        +target: str
        +condition: Callable | None
    }

    class DiGraphBuilder AGENTCHAT_COLOR {
        +{static} from_agents(agents: List[ChatAgent]): DiGraph
    }

    class GraphFlow AGENTCHAT_COLOR {
        #_graph: DiGraph
        +__init__(graph: DiGraph, termination_condition, max_turns)
        +run(task, cancellation_token, output_task_messages): TaskResult
    }
}

Team <|.. BaseGroupChat
TaskRunner <|.. BaseGroupChat

BaseGroupChat <|-- RoundRobinGroupChat
BaseGroupChat <|-- SelectorGroupChat
BaseGroupChat <|-- Swarm
BaseGroupChat <|-- MagenticOneGroupChat
Team <|.. GraphFlow

Component <|.. RoundRobinGroupChat
Component <|.. SelectorGroupChat
Component <|.. Swarm
Component <|.. MagenticOneGroupChat
Component <|.. GraphFlow

BaseGroupChat o-- ChatAgent : manages
BaseGroupChat o-- TerminationCondition : uses

SelectorGroupChat o-- ChatCompletionClient : uses
MagenticOneGroupChat o-- ChatCompletionClient : uses
Swarm o-- Handoff : uses

GraphFlow *-- DiGraph
DiGraph *-- DiGraphNode
DiGraph *-- DiGraphEdge
DiGraphNode o-- ChatAgent

' ============================================================================
' EXTENSION AGENTS
' ============================================================================

package "autogen_ext.agents" <<Rectangle>> {

    class MultimodalWebSurfer EXTENSIONS_COLOR {
        #_playwright_controller: PlaywrightController
        #_model_client: ChatCompletionClient
        +on_messages(messages, cancellation_token): Response
    }

    class FileSurfer EXTENSIONS_COLOR {
        #_model_client: ChatCompletionClient
        +on_messages(messages, cancellation_token): Response
    }

    class VideoSurfer EXTENSIONS_COLOR {
        #_model_client: ChatCompletionClient
        +on_messages(messages, cancellation_token): Response
    }

    class OpenAIAgent EXTENSIONS_COLOR {
        #_openai_client: OpenAI
        #_assistant_id: str
        +on_messages(messages, cancellation_token): Response
    }

    class OpenAIAssistantAgent EXTENSIONS_COLOR {
        #_openai_client: OpenAI
        #_assistant: Assistant
        +on_messages(messages, cancellation_token): Response
    }

    class AzureAIAgent EXTENSIONS_COLOR {
        #_azure_client: AIProjectClient
        #_agent_id: str
        +on_messages(messages, cancellation_token): Response
    }

    class MagenticOneCoderAgent EXTENSIONS_COLOR {
        #_model_client: ChatCompletionClient
        +on_messages(messages, cancellation_token): Response
    }

    class PlaywrightController EXTENSIONS_COLOR {
        #_browser: Browser
        #_page: Page
        +navigate(url: str)
        +click(selector: str)
        +type_text(selector: str, text: str)
        +screenshot(): bytes
    }
}

BaseChatAgent <|-- MultimodalWebSurfer
BaseChatAgent <|-- FileSurfer
BaseChatAgent <|-- VideoSurfer
BaseChatAgent <|-- OpenAIAgent
BaseChatAgent <|-- OpenAIAssistantAgent
BaseChatAgent <|-- AzureAIAgent
BaseChatAgent <|-- MagenticOneCoderAgent

MultimodalWebSurfer o-- PlaywrightController : uses
MultimodalWebSurfer o-- ChatCompletionClient : uses

' ============================================================================
' EXTENSION TEAMS
' ============================================================================

package "autogen_ext.teams" <<Rectangle>> {

    class MagenticOne EXTENSIONS_COLOR {
        #_orchestrator: MagenticOneCoderAgent
        #_web_surfer: MultimodalWebSurfer
        #_file_surfer: FileSurfer
        #_coder: MagenticOneCoderAgent
        +run(task, cancellation_token, output_task_messages): TaskResult
    }
}

Team <|.. MagenticOne
Component <|.. MagenticOne

' ============================================================================
' AGENTCHAT STATE CLASSES
' ============================================================================

package "autogen_agentchat.state" <<Rectangle>> {

    abstract class BaseState AGENTCHAT_COLOR {
        +version: int
    }

    class AssistantAgentState AGENTCHAT_COLOR {
        +message_history: List
        +tool_state: Dict
    }

    class BaseGroupChatManagerState AGENTCHAT_COLOR {
        +message_history: List
        +turn_count: int
    }

    class ChatAgentContainerState AGENTCHAT_COLOR {
        +agent_states: Dict[str, BaseState]
    }

    class RoundRobinManagerState AGENTCHAT_COLOR {
        +current_turn: int
    }

    class SelectorManagerState AGENTCHAT_COLOR {
        +selection_history: List[str]
    }

    class SwarmManagerState AGENTCHAT_COLOR {
        +current_agent: str
        +handoff_history: List
    }

    class MagenticOneOrchestratorState AGENTCHAT_COLOR {
        +task_ledger: List
        +facts: List
    }

    class TeamState AGENTCHAT_COLOR {
        +team_id: str
        +participant_states: Dict
    }

    class SocietyOfMindAgentState AGENTCHAT_COLOR {
        +inner_team_state: TeamState
    }
}

BaseState <|-- AssistantAgentState
BaseState <|-- BaseGroupChatManagerState
BaseState <|-- ChatAgentContainerState
BaseState <|-- RoundRobinManagerState
BaseState <|-- SelectorManagerState
BaseState <|-- SwarmManagerState
BaseState <|-- MagenticOneOrchestratorState
BaseState <|-- TeamState
BaseState <|-- SocietyOfMindAgentState

BaseGroupChatManagerState <|-- RoundRobinManagerState
BaseGroupChatManagerState <|-- SelectorManagerState
BaseGroupChatManagerState <|-- SwarmManagerState
BaseGroupChatManagerState <|-- MagenticOneOrchestratorState

' ============================================================================
' UI AND UTILITIES
' ============================================================================

package "autogen_agentchat.ui" <<Rectangle>> {

    class Console AGENTCHAT_COLOR {
        +{static} print(message: BaseChatMessage)
        +{static} print_event(event: BaseAgentEvent)
    }

    class UserInputManager AGENTCHAT_COLOR {
        +get_input(prompt: str): str
    }
}

package "autogen_ext.ui" <<Rectangle>> {

    class RichConsole EXTENSIONS_COLOR {
        +print(message: BaseChatMessage)
        +print_event(event: BaseAgentEvent)
    }
}

' ============================================================================
' LOGGING AND TRACING
' ============================================================================

package "autogen_core.logging" <<Rectangle>> {

    class LLMCallEvent CORE_COLOR {
        +prompt_tokens: int
        +completion_tokens: int
        +model: str
    }

    class LLMStreamStartEvent CORE_COLOR {
        +model: str
    }

    class LLMStreamEndEvent CORE_COLOR {
        +prompt_tokens: int
        +completion_tokens: int
    }

    class ToolCallEvent CORE_COLOR {
        +tool_name: str
        +arguments: Dict
        +result: Any
    }

    enum MessageKind CORE_COLOR {
        SEND
        PUBLISH
        RESPONSE
    }

    enum DeliveryStage CORE_COLOR {
        SEND
        DELIVER
        HANDLE
    }

    class MessageEvent CORE_COLOR {
        +kind: MessageKind
        +stage: DeliveryStage
        +sender: AgentId
        +recipient: AgentId
    }

    class MessageDroppedEvent CORE_COLOR {
        +message: Any
        +reason: str
    }

    class MessageHandlerExceptionEvent CORE_COLOR {
        +exception: Exception
        +agent_id: AgentId
    }

    class AgentConstructionExceptionEvent CORE_COLOR {
        +exception: Exception
        +agent_type: str
    }
}

' ============================================================================
' INTERVENTION
' ============================================================================

package "autogen_core (Intervention)" <<Rectangle>> {

    class DropMessage CORE_COLOR {
        +message: str
    }

    interface InterventionHandler <<Protocol>> PROTOCOL_COLOR {
        +{abstract} on_send(message, sender: AgentId, recipient: AgentId)
        +{abstract} on_publish(message, sender: AgentId, topic_id: TopicId)
        +{abstract} on_response(message, sender: AgentId, recipient: AgentId)
    }

    class DefaultInterventionHandler CORE_COLOR {
        +on_send(message, sender: AgentId, recipient: AgentId)
        +on_publish(message, sender: AgentId, topic_id: TopicId)
        +on_response(message, sender: AgentId, recipient: AgentId)
    }
}

InterventionHandler <|.. DefaultInterventionHandler

@enduml