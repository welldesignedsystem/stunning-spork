@startuml Agent_Framework

' ============ BASE INTERFACES AND PROTOCOLS ============

interface TaskRunner <<Protocol>> {
    +run(task, cancellation_token, output_task_messages): TaskResult
    +run_stream(task, cancellation_token, output_task_messages): AsyncGenerator
}

interface ComponentBase {
    +component_type: ComponentType
}

interface Component<T> {
    +component_version: int
    +component_config_schema: type
    +component_provider_override: str
    +_to_config(): T
    +_from_config(config: T): Self
}

abstract class ABC

' ============ MODEL CLIENT HIERARCHY ============
rectangle "Chat Completion Client" #FFE4B5 {
    interface ChatCompletionClient <<Protocol>> {
        +{abstract} create(messages, tools, json_output, extra_create_args, cancellation_token): CreateResult
        +{abstract} create_stream(messages, tools, json_output, extra_create_args, cancellation_token): AsyncGenerator<str | CreateResult>
        +{abstract} actual_usage(): RequestUsage
        +{abstract} total_usage(): RequestUsage
        +{abstract} count_tokens(messages, tools, json_output): int
        +{abstract} remaining_tokens(messages, tools, json_output): int
    }

    abstract class BaseOpenAIChatCompletionClient {
        +{static} component_type: ClassVar<ComponentType>
        #_model: str
        #_api_key: str | None
        #_base_url: str | None
        #_timeout: float | None
        #_max_retries: int
        #_model_info: ModelInfo
        #_client: AsyncOpenAI
        +__init__(model, api_key, base_url, timeout, max_retries, model_info, ...)
        +create(messages, tools, json_output, extra_create_args, cancellation_token): CreateResult
        +create_stream(messages, tools, json_output, extra_create_args, cancellation_token): AsyncGenerator
        +actual_usage(): RequestUsage
        +total_usage(): RequestUsage
        +count_tokens(messages, tools, json_output): int
        +remaining_tokens(messages, tools, json_output): int
        +close(): None
    }

    class OpenAIChatCompletionClient {
        +{static} component_version: ClassVar<int>
        +{static} component_provider_override: ClassVar<str>
        +__init__(model, api_key, organization, base_url, timeout, max_retries, model_info, ...)
        +_to_config(): OpenAIClientConfigurationConfigModel
        +_from_config(config): Self
    }

    class AzureOpenAIChatCompletionClient {
        +{static} component_version: ClassVar<int>
        +{static} component_provider_override: ClassVar<str>
        #_azure_deployment: str
        #_azure_endpoint: str
        #_api_version: str
        #_azure_ad_token_provider: Callable | None
        +__init__(azure_deployment, model, azure_endpoint, api_version, api_key, azure_ad_token_provider, ...)
        +_to_config(): AzureOpenAIClientConfigurationConfigModel
        +_from_config(config): Self
    }

    abstract class BaseAnthropicChatCompletionClient {
        +{static} component_type: ClassVar<ComponentType>
        #_model: str
        #_api_key: str | None
        #_base_url: str | None
        #_timeout: float
        #_max_tokens: int
        #_temperature: float
        #_client: AsyncAnthropic
        +__init__(model, api_key, base_url, timeout, max_tokens, temperature, ...)
        +create(messages, tools, json_output, extra_create_args, cancellation_token): CreateResult
        +create_stream(messages, tools, json_output, extra_create_args, cancellation_token): AsyncGenerator
        +actual_usage(): RequestUsage
        +total_usage(): RequestUsage
        +count_tokens(messages, tools, json_output): int
        +remaining_tokens(messages, tools, json_output): int
        +close(): None
    }

    class AnthropicChatCompletionClient {
        +{static} component_version: ClassVar<int>
        +{static} component_provider_override: ClassVar<str>
        +__init__(model, api_key, max_tokens, temperature, ...)
        +_to_config(): AnthropicClientConfigurationConfigModel
        +_from_config(config): Self
    }

    class AnthropicBedrockChatCompletionClient {
        +{static} component_version: ClassVar<int>
        +{static} component_provider_override: ClassVar<str>
        #_aws_region: str
        #_aws_access_key_id: str | None
        #_aws_secret_access_key: str | None
        +__init__(model, aws_region, aws_access_key_id, aws_secret_access_key, ...)
        +_to_config(): AnthropicBedrockClientConfigurationConfigModel
        +_from_config(config): Self
    }

    abstract class BaseOllamaChatCompletionClient {
        +{static} component_type: ClassVar<ComponentType>
        #_model: str
        #_host: str
        #_timeout: float | None
        #_response_format: type | None
        #_client: AsyncClient
        +__init__(model, host, timeout, response_format, ...)
        +create(messages, tools, json_output, extra_create_args, cancellation_token): CreateResult
        +create_stream(messages, tools, json_output, extra_create_args, cancellation_token): AsyncGenerator
        +actual_usage(): RequestUsage
        +total_usage(): RequestUsage
        +count_tokens(messages, tools, json_output): int
        +remaining_tokens(messages, tools, json_output): int
        +close(): None
    }

    class OllamaChatCompletionClient {
        +{static} component_version: ClassVar<int>
        +{static} component_provider_override: ClassVar<str>
        +__init__(model, host, timeout, response_format, ...)
        +_to_config(): BaseOllamaClientConfigurationConfigModel
        +_from_config(config): Self
    }

    class SKChatCompletionAdapter {
        +{static} component_type: ClassVar<ComponentType>
        #_sk_client: ChatCompletionClientBase
        #_kernel: Kernel | None
        #_prompt_settings: PromptExecutionSettings | None
        #_model_info: ModelInfo
        #_service_id: str | None
        +__init__(sk_client, kernel, prompt_settings, model_info, service_id)
        +create(messages, tools, json_output, extra_create_args, cancellation_token): CreateResult
        +create_stream(messages, tools, json_output, extra_create_args, cancellation_token): AsyncGenerator
        +actual_usage(): RequestUsage
        +total_usage(): RequestUsage
        +count_tokens(messages, tools, json_output): int
        +remaining_tokens(messages, tools, json_output): int
    }

    class ChatCompletionCache {
        +{static} component_type: ClassVar<ComponentType>
        #_client: ChatCompletionClient
        #_cache_store: CacheStore
        +__init__(client, cache_store)
        +create(messages, tools, json_output, extra_create_args, cancellation_token): CreateResult
        +create_stream(messages, tools, json_output, extra_create_args, cancellation_token): AsyncGenerator
        +actual_usage(): RequestUsage
        +total_usage(): RequestUsage
        +count_tokens(messages, tools, json_output): int
        +remaining_tokens(messages, tools, json_output): int
        +close(): None
    }
}

class RequestUsage {
    +prompt_tokens: int
    +completion_tokens: int
    +total_tokens: int
    +__init__(prompt_tokens, completion_tokens)
}

class CreateResult {
    +content: str
    +finish_reason: str
    +usage: RequestUsage
    +cached: bool
    +logprobs: List | None
    +__init__(content, finish_reason, usage, cached, logprobs)
}

ChatCompletionClient <|.. BaseOpenAIChatCompletionClient
BaseOpenAIChatCompletionClient <|-- OpenAIChatCompletionClient
BaseOpenAIChatCompletionClient <|-- AzureOpenAIChatCompletionClient
Component <|.. OpenAIChatCompletionClient
Component <|.. AzureOpenAIChatCompletionClient

ChatCompletionClient <|.. BaseAnthropicChatCompletionClient
BaseAnthropicChatCompletionClient <|-- AnthropicChatCompletionClient
BaseAnthropicChatCompletionClient <|-- AnthropicBedrockChatCompletionClient
Component <|.. AnthropicChatCompletionClient
Component <|.. AnthropicBedrockChatCompletionClient

ChatCompletionClient <|.. BaseOllamaChatCompletionClient
BaseOllamaChatCompletionClient <|-- OllamaChatCompletionClient
Component <|.. OllamaChatCompletionClient

ChatCompletionClient <|.. SKChatCompletionAdapter

ChatCompletionClient <|.. ChatCompletionCache
ChatCompletionCache o-- ChatCompletionClient : wraps

ChatCompletionClient ..> CreateResult : produces
ChatCompletionClient ..> RequestUsage : produces

' ============ LLM MESSAGE TYPES ============
rectangle "Base Model" #LightBlue {

    abstract class BaseModel {
        +{abstract} content: str | List
        +role: str
    }

    class SystemMessage {
        +content: str
        +role: str = "system"
        +__init__(content: str)
    }

    class UserMessage {
        +content: str | List
        +role: str = "user"
        +__init__(content: str | List)
    }

    class AssistantMessage {
        +content: str | None
        +function_call: FunctionCall | None
        +tool_calls: List<FunctionCall> | None
        +role: str = "assistant"
        +__init__(content, function_call, tool_calls)
    }

    class FunctionExecutionResultMessage {
        +content: str
        +role: str = "function"
        +call_id: str
        +__init__(content: str, call_id: str)
    }
}
BaseModel <|-- SystemMessage
BaseModel <|-- UserMessage
BaseModel <|-- AssistantMessage
BaseModel <|-- FunctionExecutionResultMessage

' ============ TOOL HIERARCHY ============
rectangle "base tool" #D8BFD8 {
    abstract class BaseTool {
        +{abstract} name: str
        +{abstract} description: str
        +{abstract} args_type: type
        +{abstract} return_type: type
        +{abstract} run_json(args: str, cancellation_token): str
        +{abstract} run(args, cancellation_token): Any
        +{abstract} to_tool_schema(): ToolSchema
    }
    class BaseToolWithState {
    }
    class BaseStreamTool {}
    class FunctionTool {
    }
    class PythonCodeExecutionTool {
    }

    BaseTool <|-- PythonCodeExecutionTool
    BaseTool <|-- FunctionTool
    BaseTool <|-- BaseStreamTool
    BaseTool <|-- BaseToolWithState
    BaseTool <|-- AgentTool
    BaseTool <|-- MCPTool
}

class TeamTaskResult {
    +messages: Sequence<BaseChatMessage>
    +stop_reason: str | None
    +participant_results: Dict<str, TaskResult>
    +conversation_history: List<BaseChatMessage>
    +__init__(messages, stop_reason, participant_results, conversation_history)
}

interface ChatAgent <<Protocol>> {
    +name: str
    +description: str
    +run(task: str, cancellation_token): TaskResult
}

class TaskResult {
    +messages: Sequence<BaseChatMessage>
    +stop_reason: str | None
    +__init__(messages, stop_reason)
}

class ToolSchema {
    +name: str
    +description: str
    +parameters: Dict
    +__init__(name, description, parameters)
}

class FunctionCall {
    +id: str
    +name: str
    +arguments: str
    +__init__(id, name, arguments)
}

class FunctionExecutionResult {
    +content: str
    +call_id: str
    +__init__(content: str, call_id: str)
}


' ============ MCP (Model Context Protocol) COMPONENTS ============

class MCPToolDefinition {
    +name: str
    +description: str
    +input_schema: Dict
    +__init__(name, description, input_schema)
}

class MCPToolResult {
    +content: str | List
    +is_error: bool
    +__init__(content, is_error)
}

class MCPResource {
    +uri: str
    +name: str
    +description: str
    +mime_type: str
    +__init__(uri, name, description, mime_type)
}

class MCPResourceContent {
    +uri: str
    +content: str | bytes
    +mime_type: str
    +__init__(uri, content, mime_type)
}
rectangle "model context protocol" #FFB1C1 {

    interface MCPClient <<Protocol>> {
        +{abstract} list_tools(): List<MCPToolDefinition>
        +{abstract} call_tool(tool_name: str, arguments: Dict): MCPToolResult
        +{abstract} list_resources(): List<MCPResource>
        +{abstract} read_resource(uri: str): MCPResourceContent
        +{abstract} connect(): None
        +{abstract} disconnect(): None
    }

    class StdioMCPClient {
        #_command: str
        #_args: List<str>
        #_process: asyncio.subprocess.Process
        #_connected: bool
        +__init__(command: str, args: List<str>)
        +list_tools(): List<MCPToolDefinition>
        +call_tool(tool_name: str, arguments: Dict): MCPToolResult
        +list_resources(): List<MCPResource>
        +read_resource(uri: str): MCPResourceContent
        +connect(): None
        +disconnect(): None
    }

    class HttpMCPClient {
        #_base_url: str
        #_headers: Dict
        #_session: aiohttp.ClientSession
        +__init__(base_url: str, headers: Dict)
        +list_tools(): List<MCPToolDefinition>
        +call_tool(tool_name: str, arguments: Dict): MCPToolResult
        +list_resources(): List<MCPResource>
        +read_resource(uri: str): MCPResourceContent
        +connect(): None
        +disconnect(): None
    }
}
MCPClient <|.. StdioMCPClient
MCPClient <|.. HttpMCPClient
MCPClient ..> MCPToolDefinition : provides
MCPClient ..> MCPToolResult : produces
MCPClient ..> MCPResource : provides
MCPClient ..> MCPResourceContent : produces

MCPTool o-- MCPClient : uses

' ============ CODE EXECUTOR HIERARCHY ============
rectangle "code executor base" #90EE90 {

    interface CodeExecutor <<Protocol>> {
        +{abstract} execute_code_blocks(code_blocks, cancellation_token): CodeResult
        +{abstract} restart(): None
        +{abstract} stop(): None
    }

    class LocalCommandLineCodeExecutor {
        #_work_dir: str
        #_timeout: int
        #_virtual_env: str | None
        +__init__(work_dir, timeout, virtual_env)
        +execute_code_blocks(code_blocks, cancellation_token): CodeResult
        +restart(): None
        +stop(): None
    }

    class DockerCommandLineCodeExecutor {
        #_image: str
        #_container_name: str
        #_timeout: int
        #_work_dir: str
        #_auto_remove: bool
        +__init__(image, container_name, timeout, work_dir, auto_remove)
        +execute_code_blocks(code_blocks, cancellation_token): CodeResult
        +restart(): None
        +stop(): None
    }
}
CodeExecutor <|.. LocalCommandLineCodeExecutor
CodeExecutor <|.. DockerCommandLineCodeExecutor

' ============ MEMORY HIERARCHY ============
rectangle "memory base" #ADD8E6 {
    abstract class Memory {
        +{abstract} add(message: BaseChatMessage): None
        +{abstract} get_context(recent_messages: List<BaseChatMessage>): List<BaseModel>
        +{abstract} clear(): None
    }

    class ChatHistoryMemory {
        #_max_messages: int | None
        #_messages: List<BaseChatMessage>
        +__init__(max_messages: int | None)
        +add(message: BaseChatMessage): None
        +get_context(recent_messages: List<BaseChatMessage>): List<BaseModel>
        +clear(): None
    }

    class SummaryMemory {
        #_model_client: ChatCompletionClient
        #_summary_prompt: str
        #_summary: str | None
        #_max_messages: int
        +__init__(model_client, summary_prompt, max_messages)
        +add(message: BaseChatMessage): None
        +get_context(recent_messages: List<BaseChatMessage>): List<BaseModel>
        +clear(): None
    }
}

Memory <|-- ChatHistoryMemory
Memory <|-- SummaryMemory
SummaryMemory o-- ChatCompletionClient : uses

' ============ CHAT COMPLETION CONTEXT ============

class ChatCompletionContext {
    #_messages: List<BaseModel>
    #_max_messages: int | None
    +__init__(messages: List<BaseModel>, max_messages: int | None)
    +add_message(message: LLMMessage): None
    +get_messages(): List<BaseModel>
    +clear(): None
    +truncate(max_messages: int): None
}

' ============ WORKBENCH HIERARCHY ============
rectangle "base workbench" #F0E68C {
    abstract class BaseWorkbench {
        +{abstract} root_dir: str
        +{abstract} working_dir: str
        +{abstract} create_file(path: str, content: str): str
        +{abstract} read_file(path: str): str
        +{abstract} write_file(path: str, content: str): str
        +{abstract} delete_file(path: str): None
        +{abstract} list_files(pattern: str): List<str>
        +{abstract} get_absolute_path(path: str): str
        +{abstract} exists(path: str): bool
        +{abstract} mkdir(path: str, parents: bool): str
        +{abstract} move_file(src: str, dst: str): str
        +{abstract} copy_file(src: str, dst: str): str
        +{abstract} get_file_info(path: str): FileInfo
        +{abstract} save_state(): WorkbenchState
        +{abstract} load_state(state: WorkbenchState): None
    }

    class Workbench {
        +{static} component_type: ClassVar<ComponentType>
        +root_dir: str
        +working_dir: str
        #_security_manager: SecurityManager
        +__init__(root_dir: str, security_manager: SecurityManager)
        +create_file(path: str, content: str): str
        +read_file(path: str): str
        +write_file(path: str, content: str): str
        +delete_file(path: str): None
        +list_files(pattern: str): List<str>
        +get_absolute_path(path: str): str
        +exists(path: str): bool
        +mkdir(path: str, parents: bool): str
        +move_file(src: str, dst: str): str
        +copy_file(src: str, dst: str): str
        +get_file_info(path: str): FileInfo
        +save_state(): WorkbenchState
        +load_state(state: WorkbenchState): None
    }

    class MCPWorkbench {
        +{static} component_type: ClassVar<ComponentType>
        +root_dir: str
        +working_dir: str
        #_mcp_client: MCPClient
        #_resource_prefix: str
        +__init__(mcp_client: MCPClient, resource_prefix: str)
        +create_file(path: str, content: str): str
        +read_file(path: str): str
        +write_file(path: str, content: str): str
        +delete_file(path: str): None
        +list_files(pattern: str): List<str>
        +get_absolute_path(path: str): str
        +exists(path: str): bool
        +mkdir(path: str, parents: bool): str
        +move_file(src: str, dst: str): str
        +copy_file(src: str, dst: str): str
        +get_file_info(path: str): FileInfo
        +save_state(): WorkbenchState
        +load_state(state: WorkbenchState): None
    }

    class GitWorkbench {
        +{static} component_type: ClassVar<ComponentType>
        +root_dir: str
        +working_dir: str
        #_base_workbench: BaseWorkbench
        #_repo: git.Repo
        #_auto_commit: bool
        +__init__(base_workbench: BaseWorkbench, auto_commit: bool)
        +create_file(path: str, content: str): str
        +read_file(path: str): str
        +write_file(path: str, content: str): str
        +delete_file(path: str): None
        +list_files(pattern: str): List<str>
        +get_absolute_path(path: str): str
        +exists(path: str): bool
        +mkdir(path: str, parents: bool): str
        +move_file(src: str, dst: str): str
        +copy_file(src: str, dst: str): str
        +get_file_info(path: str): FileInfo
        +commit(message: str): str
        +create_branch(branch_name: str): None
        +checkout(branch_name: str): None
        +diff(commit1: str, commit2: str): str
        +rollback(commit_hash: str): None
        +save_state(): WorkbenchState
        +load_state(state: WorkbenchState): None
    }

    class SandboxWorkbench {
        +{static} component_type: ClassVar<ComponentType>
        +root_dir: str
        +working_dir: str
        #_base_workbench: BaseWorkbench
        #_allowed_paths: List<str>
        #_blocked_paths: List<str>
        #_read_only_paths: List<str>
        #_max_file_size: int
        +__init__(base_workbench: BaseWorkbench, allowed_paths, blocked_paths, read_only_paths, max_file_size)
        +create_file(path: str, content: str): str
        +read_file(path: str): str
        +write_file(path: str, content: str): str
        +delete_file(path: str): None
        +list_files(pattern: str): List<str>
        +get_absolute_path(path: str): str
        +exists(path: str): bool
        +mkdir(path: str, parents: bool): str
        +move_file(src: str, dst: str): str
        +copy_file(src: str, dst: str): str
        +get_file_info(path: str): FileInfo
        +_validate_path(path: str): bool
        +save_state(): WorkbenchState
        +load_state(state: WorkbenchState): None
    }

    class EnvironmentWorkbench {
        +{static} component_type: ClassVar<ComponentType>
        +root_dir: str
        +working_dir: str
        #_base_workbench: BaseWorkbench
        #_env_vars: Dict<str, str>
        #_config_files: Dict<str, str>
        #_secrets_manager: SecretsManager
        +__init__(base_workbench: BaseWorkbench, secrets_manager: SecretsManager)
        +create_file(path: str, content: str): str
        +read_file(path: str): str
        +write_file(path: str, content: str): str
        +delete_file(path: str): None
        +list_files(pattern: str): List<str>
        +get_absolute_path(path: str): str
        +exists(path: str): bool
        +mkdir(path: str, parents: bool): str
        +move_file(src: str, dst: str): str
        +copy_file(src: str, dst: str): str
        +get_file_info(path: str): FileInfo
        +set_env_var(key: str, value: str): None
        +get_env_var(key: str): str
        +load_config(path: str): Dict
        +save_config(path: str, config: Dict): None
        +get_secret(key: str): str
        +set_secret(key: str, value: str): None
        +save_state(): WorkbenchState
        +load_state(state: WorkbenchState): None
    }

    class BuildWorkbench {
        +{static} component_type: ClassVar<ComponentType>
        +root_dir: str
        +working_dir: str
        #_base_workbench: BaseWorkbench
        #_build_system: str
        #_build_config: Dict
        +__init__(base_workbench: BaseWorkbench, build_system: str)
        +create_file(path: str, content: str): str
        +read_file(path: str): str
        +write_file(path: str, content: str): str
        +delete_file(path: str): None
        +list_files(pattern: str): List<str>
        +get_absolute_path(path: str): str
        +exists(path: str): bool
        +mkdir(path: str, parents: bool): str
        +move_file(src: str, dst: str): str
        +copy_file(src: str, dst: str): str
        +get_file_info(path: str): FileInfo
        +build(target: str): BuildResult
        +test(test_pattern: str): TestResult
        +install_dependencies(): None
        +run_linter(): LintResult
        +format_code(): None
        +save_state(): WorkbenchState
        +load_state(state: WorkbenchState): None
    }
}
class FileInfo {
    +path: str
    +size: int
    +created_at: datetime
    +modified_at: datetime
    +is_directory: bool
    +permissions: str
    +__init__(path, size, created_at, modified_at, is_directory, permissions)
}

class WorkbenchState {
    +working_dir: str
    +file_tree: Dict
    +metadata: Dict
    +timestamp: datetime
    +__init__(working_dir, file_tree, metadata, timestamp)
}

class SecurityManager {
    #_allowed_operations: Set<str>
    #_path_validator: PathValidator
    +__init__(allowed_operations: Set, path_validator: PathValidator)
    +validate_operation(operation: str, path: str): bool
    +sanitize_path(path: str): str
}

class SecretsManager {
    #_secrets_store: Dict<str, str>
    #_encryption_key: bytes
    +__init__(encryption_key: bytes)
    +get_secret(key: str): str
    +set_secret(key: str, value: str): None
    +delete_secret(key: str): None
    +list_secrets(): List<str>
}

class BuildResult {
    +success: bool
    +output: str
    +errors: List<str>
    +duration: float
    +__init__(success, output, errors, duration)
}

class TestResult {
    +success: bool
    +passed: int
    +failed: int
    +skipped: int
    +output: str
    +__init__(success, passed, failed, skipped, output)
}

class LintResult {
    +issues: List<LintIssue>
    +total_issues: int
    +__init__(issues, total_issues)
}

class LintIssue {
    +file: str
    +line: int
    +column: int
    +severity: str
    +message: str
    +__init__(file, line, column, severity, message)
}

BaseWorkbench <|-- Workbench
BaseWorkbench <|-- MCPWorkbench
BaseWorkbench <|-- GitWorkbench
BaseWorkbench <|-- SandboxWorkbench
BaseWorkbench <|-- EnvironmentWorkbench
BaseWorkbench <|-- BuildWorkbench

ComponentBase <|.. BaseWorkbench
Component <|.. Workbench
Component <|.. MCPWorkbench
Component <|.. GitWorkbench
Component <|.. SandboxWorkbench
Component <|.. EnvironmentWorkbench
Component <|.. BuildWorkbench

Workbench o-- SecurityManager : uses
MCPWorkbench o-- MCPClient : uses
GitWorkbench o-- BaseWorkbench : wraps
SandboxWorkbench o-- BaseWorkbench : wraps
EnvironmentWorkbench o-- BaseWorkbench : wraps
EnvironmentWorkbench o-- SecretsManager : uses
BuildWorkbench o-- BaseWorkbench : wraps

BaseWorkbench ..> FileInfo : produces
BaseWorkbench ..> WorkbenchState : produces
BuildWorkbench ..> BuildResult : produces
BuildWorkbench ..> TestResult : produces
BuildWorkbench ..> LintResult : produces

WorkbenchTool o-- BaseWorkbench : uses

' ============ MESSAGE HIERARCHY ============
rectangle "Base Message" #LightGreen {

    abstract class BaseMessage {
        +source: str
        +models_usage: RequestUsage | None
        +metadata: Dict
        +type: str
        +{abstract} to_text(): str
        +{abstract} to_model_text(): str
        +{abstract} to_model_message(): LLMMessage
    }

    abstract class BaseChatMessage {
        +source: str
        +models_usage: RequestUsage | None
        +metadata: Dict
        +type: str
        +{abstract} to_text(): str
        +{abstract} to_model_text(): str
        +{abstract} to_model_message(): LLMMessage
    }

    class BaseTextChatMessage extends BaseChatMessage, ABC {
        +content: str
        +to_text(): str
        +to_model_text(): str
        +to_model_message(): UserMessage
    }

    BaseMessage <|-- BaseChatMessage
    BaseChatMessage <|-- BaseTextChatMessage

    class TextMessage {
        +content: str
        +__init__(content: str, source: str, models_usage: RequestUsage)
    }

    class MultiModalMessage {
        +content: List<str | Image>
        +__init__(content: List, source: str, models_usage: RequestUsage)
        +to_text(): str
        +to_model_text(): str
        +to_model_message(): UserMessage
    }

    class StopMessage {
        +content: str
        +__init__(content: str, source: str)
    }

    class HandoffMessage {
        +content: str
        +target: str
        +context: List<BaseModel>
        +__init__(content: str, target: str, source: str, context: List)
    }

    class ToolCallSummaryMessage {
        +content: str
        +call_id: str
        +__init__(content: str, call_id: str, source: str)
    }

    class StructuredMessage<T> {
        +content: T
        +format_string: str | None
        +__init__(content: T, source: str, format_string: str)
        +to_text(): str
    }

    abstract class BaseAgentEvent {
        +source: str
        +metadata: Dict
        +type: str
    }

    class ToolCallRequestEvent {
        +content: str
        +__init__(content: str, source: str)
    }

    class ToolCallExecutionEvent {
        +content: List<FunctionExecutionResult>
        +__init__(content: List, source: str)
    }

    class MemoryQueryEvent {
        +query: str
        +__init__(query: str, source: str)
    }

    class UserInputRequestedEvent {
        +prompt: str
        +__init__(prompt: str, source: str)
    }

    class ModelClientStreamingChunkEvent {
        +content: str
        +__init__(content: str, source: str)
    }

    class ThoughtEvent {
        +thought: str
        +__init__(thought: str, source: str)
    }

    class SelectSpeakerEvent {
        +speaker: str
        +__init__(speaker: str, source: str)
    }

    class CodeGenerationEvent {
        +code: str
        +__init__(code: str, source: str)
    }

    class CodeExecutionEvent {
        +result: str
        +__init__(result: str, source: str)
    }
}

BaseMessage <|-- BaseAgentEvent
BaseTextChatMessage <|-- HandoffMessage
BaseTextChatMessage <|-- StopMessage
BaseTextChatMessage <|-- TextMessage
BaseTextChatMessage <|-- ToolCallSummaryMessage
BaseChatMessage <|-- StructuredMessage
BaseChatMessage <|-- MultiModalMessage
BaseAgentEvent <|-- ToolCallRequestEvent
BaseAgentEvent <|-- ToolCallExecutionEvent
BaseAgentEvent <|-- MemoryQueryEvent
BaseAgentEvent <|-- UserInputRequestedEvent
BaseAgentEvent <|-- ModelClientStreamingChunkEvent
BaseAgentEvent <|-- ThoughtEvent
BaseAgentEvent <|-- SelectSpeakerEvent
BaseAgentEvent <|-- CodeGenerationEvent
BaseAgentEvent <|-- CodeExecutionEvent

' ============ CONCRETE AGENT IMPLEMENTATIONS ============

' ============ BASE AGENT CLASS ============

rectangle "base chat agent" #FFA07A {
    abstract class BaseChatAgent {
        +{static} component_type: ClassVar<ComponentType>
        #_name: str
        #_description: str
        +__init__(name: str, description: str)
        +name: str
        +description: str
        +{abstract} produced_message_types: Sequence<type>
        +{abstract} on_messages(messages, cancellation_token): Response
        +on_messages_stream(messages, cancellation_token): AsyncGenerator
        +{abstract} on_reset(cancellation_token): None
        +on_pause(cancellation_token): None
        +on_resume(cancellation_token): None
        +save_state(): Mapping
        +load_state(state): None
        +close(): None
        +run(task, cancellation_token, output_task_messages): TaskResult
        +run_stream(task, cancellation_token, output_task_messages): AsyncGenerator
    }

    class AssistantAgent {
        +{static} component_version: ClassVar<int>
        +{static} component_provider_override: ClassVar<str>
        #_model_client: ChatCompletionClient
        #_tools: List<BaseTool>
        #_workbench: Workbench | None
        #_handoffs: List<Handoff>
        #_model_context: ChatCompletionContext
        #_system_message: str
        #_reflect_on_tool_use: bool
        #_max_tool_iterations: int
        #_tool_call_summary_formatter: Callable
        #_output_content_type: type<BaseModel> | None
        #_memory: Sequence<Memory>
        +__init__(name, model_client, tools, workbench, handoffs, ...)
        +produced_message_types: Sequence<type>
        +model_context: ChatCompletionContext
        +on_messages(messages, cancellation_token): Response
        +on_messages_stream(messages, cancellation_token): AsyncGenerator
        +on_reset(cancellation_token): None
        +save_state(): Mapping
        +load_state(state): None
    }

    class CodeExecutorAgent {
        +{static} component_provider_override: ClassVar<str>
        +{static} DEFAULT_TERMINAL_DESCRIPTION: str
        +{static} DEFAULT_AGENT_DESCRIPTION: str
        +{static} DEFAULT_SYSTEM_MESSAGE: str
        +{static} NO_CODE_BLOCKS_FOUND_MESSAGE: str
        +{static} DEFAULT_SUPPORTED_LANGUAGES: List<str>
        #_code_executor: CodeExecutor
        #_model_client: ChatCompletionClient | None
        #_model_context: ChatCompletionContext | None
        #_max_retries_on_error: int
        #_sources: Sequence<str>
        #_supported_languages: List<str>
        #_approval_func: Callable
        +__init__(name, code_executor, model_client, ...)
        +produced_message_types: Sequence<type>
        +model_context: ChatCompletionContext
        +on_messages(messages, cancellation_token): Response
        +on_messages_stream(messages, cancellation_token): AsyncGenerator
        +extract_code_blocks_from_messages(messages): List<CodeBlock>
        +execute_code_block(code_blocks, cancellation_token): CodeResult
        +on_reset(cancellation_token): None
    }

    class UserProxyAgent {
        +{static} component_type: ClassVar<ComponentType>
        +{static} component_provider_override: ClassVar<str>
        #_input_func: InputFuncType
        +__init__(name, description, input_func)
        +produced_message_types: Sequence<type>
        +on_messages(messages, cancellation_token): Response
        +on_messages_stream(messages, cancellation_token): AsyncGenerator
        +on_reset(cancellation_token): None
    }

    class SocietyOfMindAgent {
        +{static} component_provider_override: ClassVar<str>
        +{static} DEFAULT_INSTRUCTION: str
        +{static} DEFAULT_RESPONSE_PROMPT: str
        +{static} DEFAULT_DESCRIPTION: str
        #_team: Team
        #_model_client: ChatCompletionClient
        #_instruction: str
        #_response_prompt: str
        #_model_context: ChatCompletionContext
        +__init__(name, team, model_client, ...)
        +produced_message_types: Sequence<type>
        +model_context: ChatCompletionContext
        +on_messages(messages, cancellation_token): Response
        +on_messages_stream(messages, cancellation_token): AsyncGenerator
        +on_reset(cancellation_token): None
        +save_state(): Mapping
        +load_state(state): None
    }
}
TaskRunner <|.. BaseChatAgent
ChatAgent <|.. BaseChatAgent
ABC <|-- BaseChatAgent
ComponentBase <|.. BaseChatAgent

BaseChatAgent <|-- AssistantAgent
Component <|.. AssistantAgent

BaseChatAgent <|-- CodeExecutorAgent
Component <|.. CodeExecutorAgent

BaseChatAgent <|-- UserProxyAgent
Component <|.. UserProxyAgent

BaseChatAgent <|-- SocietyOfMindAgent
Component <|.. SocietyOfMindAgent

' Agent compositions
AssistantAgent o-- ChatCompletionClient : uses
AssistantAgent o-- BaseTool : uses
AssistantAgent o-- Workbench : uses
AssistantAgent o-- ChatCompletionContext : uses
AssistantAgent o-- Memory : uses

CodeExecutorAgent o-- CodeExecutor : uses
CodeExecutorAgent o-- ChatCompletionClient : uses
CodeExecutorAgent o-- ChatCompletionContext : uses

SocietyOfMindAgent o-- ChatCompletionClient : uses
SocietyOfMindAgent o-- ChatCompletionContext : uses

' ============ RESPONSE AND RESULT TYPES ============

class Response {
    +chat_message: BaseChatMessage
    +inner_messages: List | None
    +__init__(chat_message, inner_messages)
}

class TaskResult {
    +messages: Sequence<BaseChatMessage>
    +stop_reason: str | None
    +__init__(messages, stop_reason)
}

' ============ TERMINATION CONDITIONS ============
rectangle "termination condition base" #FFB6C1 {
    abstract class TerminationCondition {
        +{static} component_type: ClassVar<ComponentType>
        +{abstract} terminated: bool
        +{abstract} __call__(messages): StopMessage | None
        +{abstract} reset(): None
        +__or__(other): OrTerminationCondition
        +__and__(other): AndTerminationCondition
    }

    class MaxMessageTermination {
        +{static} component_provider_override: ClassVar<str>
        #_max_messages: int
        #_message_count: int
        #_terminated: bool
        +__init__(max_messages: int)
        +terminated: bool
        +__call__(messages): StopMessage | None
        +reset(): None
    }

    class TextMentionTermination {
        +{static} component_provider_override: ClassVar<str>
        #_text: str
        #_sources: List<str> | None
        #_terminated: bool
        +__init__(text: str, sources: List)
        +terminated: bool
        +__call__(messages): StopMessage | None
        +reset(): None
    }

    class HandoffTermination {
        +{static} component_provider_override: ClassVar<str>
        #_target: str
        #_terminated: bool
        +__init__(target: str)
        +terminated: bool
        +__call__(messages): StopMessage | None
        +reset(): None
    }

    class TokenUsageTermination {
        +{static} component_provider_override: ClassVar<str>
        #_max_prompt_tokens: int | None
        #_max_completion_tokens: int | None
        #_prompt_token_count: int
        #_completion_token_count: int
        #_terminated: bool
        +__init__(max_prompt_tokens, max_completion_tokens)
        +terminated: bool
        +__call__(messages): StopMessage | None
        +reset(): None
    }

    class ExternalTermination {
        +{static} component_provider_override: ClassVar<str>
        #_terminated: bool
        +__init__()
        +terminated: bool
        +set(): None
        +__call__(messages): StopMessage | None
        +reset(): None
    }

    class TextMessageTermination {
        +{static} component_provider_override: ClassVar<str>
        #_sources: List<str> | None
        #_terminated: bool
        +__init__(sources: List)
        +terminated: bool
        +__call__(messages): StopMessage | None
        +reset(): None
    }

    class FunctionCallTermination {
        +{static} component_provider_override: ClassVar<str>
        #_function_name: str
        #_terminated: bool
        +__init__(function_name: str)
        +terminated: bool
        +__call__(messages): StopMessage | None
        +reset(): None
    }

    class OrTerminationCondition {
        +{static} component_provider_override: ClassVar<str>
        #_conditions: Tuple<TerminationCondition>
        +__init__(*conditions)
        +terminated: bool
        +__call__(messages): StopMessage | None
        +reset(): None
    }

    class AndTerminationCondition {
        +{static} component_provider_override: ClassVar<str>
        #_conditions: Tuple<TerminationCondition>
        +__init__(*conditions)
        +terminated: bool
        +__call__(messages): StopMessage | None
        +reset(): None
    }
}

ComponentBase <|.. TerminationCondition
Component <|.. TerminationCondition

TerminationCondition <|-- MaxMessageTermination
TerminationCondition <|-- TextMentionTermination
TerminationCondition <|-- HandoffTermination
TerminationCondition <|-- TokenUsageTermination
TerminationCondition <|-- ExternalTermination
TerminationCondition <|-- TextMessageTermination
TerminationCondition <|-- FunctionCallTermination
TerminationCondition <|-- OrTerminationCondition
TerminationCondition <|-- AndTerminationCondition

' ============ TEAM HIERARCHY ============

rectangle "group chat" #D1F7F3 {

    interface Team <<Protocol>> {
        +name: str
        +description: str
        +run(task, cancellation_token, output_task_messages): TaskResult
        +run_stream(task, cancellation_token, output_task_messages): AsyncGenerator
        +reset(): None
        +pause(): None
        +resume(): None
        +save_state(): Mapping
        +load_state(state): None
        +close(): None
    }

    abstract class BaseGroupChat {
        #_name: str
        #_description: str
        #_participants: List<ChatAgent | Team>
        #_participant_names: List<str>
        #_termination_condition: TerminationCondition | None
        #_max_turns: int | None
        +__init__(participants, name, description, termination_condition, max_turns)
        +name: str
        +description: str
        +run(task, cancellation_token, output_task_messages): TaskResult
        +run_stream(task, cancellation_token, output_task_messages): AsyncGenerator
        +reset(): None
        +pause(): None
        +resume(): None
        +save_state(): Mapping
        +load_state(state): None
        +close(): None
    }

    class RoundRobinGroupChat {
        +{static} component_config_schema: ClassVar<type>
        +{static} component_provider_override: ClassVar<str>
        +{static} DEFAULT_NAME: str
        +{static} DEFAULT_DESCRIPTION: str
        #_next_speaker_index: int
        +__init__(participants, name, description, termination_condition, max_turns, custom_message_types)
        +_select_speaker(history): str
        +_to_config(): RoundRobinGroupChatConfig
        +_from_config(config): Self
    }

    class SelectorGroupChat {
        +{static} component_config_schema: ClassVar<type>
        +{static} component_provider_override: ClassVar<str>
        +{static} DEFAULT_NAME: str
        +{static} DEFAULT_DESCRIPTION: str
        +{static} DEFAULT_SELECTOR_PROMPT: str
        #_model_client: ChatCompletionClient
        #_selector_prompt: str
        #_allow_repeated_speaker: bool
        #_selector_func: Callable | None
        +__init__(participants, model_client, name, description, ...)
        +_select_speaker(history): str
        +_to_config(): SelectorGroupChatConfig
        +_from_config(config): Self
    }

    class Swarm {
        +{static} component_config_schema: ClassVar<type>
        +{static} component_provider_override: ClassVar<str>
        +{static} DEFAULT_NAME: str
        +{static} DEFAULT_DESCRIPTION: str
        +__init__(participants, name, description, termination_condition, max_turns)
        +_to_config(): SwarmConfig
        +_from_config(config): Self
    }

    class MagenticOneGroupChat {
        +{static} component_config_schema: ClassVar<type>
        +{static} component_provider_override: ClassVar<str>
        +{static} DEFAULT_NAME: str
        +{static} DEFAULT_DESCRIPTION: str
        +__init__(participants, model_client, name, description, termination_condition, max_turns)
        +_to_config(): MagenticOneGroupChatConfig
        +_from_config(config): Self
    }
}

TaskRunner <|.. Team
Team <|.. BaseGroupChat

BaseGroupChat <|-- RoundRobinGroupChat
Component <|.. RoundRobinGroupChat

BaseGroupChat <|-- SelectorGroupChat
Component <|.. SelectorGroupChat

BaseGroupChat <|-- Swarm
Component <|.. Swarm

BaseGroupChat <|-- MagenticOneGroupChat
Component <|.. MagenticOneGroupChat

SelectorGroupChat o-- ChatCompletionClient : uses
MagenticOneGroupChat o-- ChatCompletionClient : uses

' ============ SUPPORT CLASSES ============

class Handoff {
    +target: str
    +message: str
    +condition: Callable | None
    +__init__(target, message, condition)
}

class ApprovalRequest {
    +code: str
    +context: List<BaseModel>
    +__init__(code, context)
}

class ApprovalResponse {
    +approved: bool
    +reason: str
    +__init__(approved, reason)
}

class CodeBlock {
    +language: str
    +code: str
}

class CodeResult {
    +exit_code: int
    +output: str
}

class Image {
    +data: bytes
    +mime_type: str
    +__init__(data, mime_type)
}

' ============ RELATIONSHIPS ============


WorkbenchTool <|-- FileReadTool
WorkbenchTool <|-- FileWriteTool
WorkbenchTool <|-- FileListTool
WorkbenchTool <|-- FileDeleteTool

BaseTool ..> ToolSchema : creates
BaseTool ..> FunctionExecutionResult : produces
BaseTool ..> FunctionCall : receives

ToolSchema o-- ToolParameter : contains

AgentTool o-- ChatAgent : wraps
AgentTool ..> TaskResult : produces

TeamTool o-- Team : wraps
TeamTool ..> TeamTaskResult : produces

MCPTool o-- MCPClient : uses
MCPTool ..> MCPToolDefinition : uses
MCPTool ..> MCPToolResult : produces

WorkbenchTool o-- BaseWorkbench : uses

WebSearchTool ..> SearchResult : produces

ToolGroup o-- BaseTool : contains
ConditionalTool o-- BaseTool : delegates to
SequentialTool o-- BaseTool : orchestrates

ToolRegistry o-- BaseTool : manages
ToolDecorator ..> FunctionTool : creates
ToolDecorator ..> AsyncFunctionTool : creates

note right of BaseModel
    Creates a single response from the model.
end note

note right of AgentTool
  **AgentTool** wraps a ChatAgent
  as a tool, enabling agents to
  delegate tasks to other agents.

  Key features:
  - Can pass conversation context
  - Limits max turns
  - Formats agent output as tool result
end note

note right of TeamTool
  **TeamTool** wraps an entire Team
  (multi-agent collaboration) as a tool.

  Key features:
  - Delegates complex tasks to teams
  - Can return full conversation history
  - Provides summarized results
  - Tracks individual participant results
end note

note bottom of ToolGroup
  **ToolGroup** bundles related tools
  for organization and discovery
end note

note bottom of ConditionalTool
  **ConditionalTool** selects between
  two tools based on runtime conditions
end note

note bottom of SequentialTool
  **SequentialTool** chains multiple
  tools together in a pipeline
end note

@enduml

